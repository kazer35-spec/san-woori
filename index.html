<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‚°ìš°ë¦¬ - ìŠ¤ë§ˆíŠ¸ í™œë™ ê´€ë¦¬</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
body { font-family: 'Pretendard', sans-serif; background-color: #f4f7f9; color: #333; }
.main-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
input, select, .btn-submit { width: 100% !important; display: block; padding: 12px 16px; border-radius: 12px; font-size: 0.95rem; height: 52px; border: 1.5px solid #e2e8f0; outline: none; }
.input-gap { margin-bottom: 16px; }
.btn-submit { font-weight: 800; color: white; border: none; cursor: pointer; transition: 0.2s; margin-top: 10px; }
.q-btn { flex: 1; py: 8px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; border: 1px solid #e2e8f0; background: white; color: #64748b; }
.active-q { background: #1d4ed8 !important; color: white !important; border-color: #1d4ed8 !important; }
.tab-menu { display: flex; background: #f8fafc; padding: 12px; gap: 10px; border-bottom: 1px solid #e2e8f0; }
.tab-btn { flex: 1; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 0.95rem; border: 1px solid #e2e8f0; background: white; color: #64748b; }
.active-tab { background: #3b82f6; color: white; border: none; }
@keyframes green-blink { 0% { opacity: 1; filter: drop-shadow(0 0 2px #22c55e); transform: scale(1); } 50% { opacity: 0.3; filter: drop-shadow(0 0 8px #4ade80); transform: scale(1.1); } 100% { opacity: 1; filter: drop-shadow(0 0 2px #22c55e); transform: scale(1); } }
.green-blinking-emoji { display: inline-block; animation: green-blink 1.2s infinite ease-in-out; color: #22c55e; margin-right: 4px; }
.card { background: white; border-radius: 20px; border: 1px solid #f1f5f9; padding: 20px; margin: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
.card-title { font-size: 1.05rem; font-weight: 800; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
table { width: 100%; border-collapse: collapse; table-layout: fixed; }
th { color: #94a3b8; font-size: 0.75rem; padding-bottom: 12px; border-bottom: 2px solid #f8fafc; }
td { padding: 14px 0; text-align: center; font-weight: 700; vertical-align: middle; }
.rank-badge { font-size: 0.65rem; display: block; margin-bottom: -3px; font-weight: 900; }
.rank-1 { color: #facc15 !important; } .rank-2 { color: #94a3b8 !important; } .rank-3 { color: #a36a00 !important; }
.badge-level { display: inline-flex; flex-direction: column; align-items: center; background: #f0fdf4; border: 1px solid #bbf7d0; padding: 4px 8px; border-radius: 10px; min-width: 80px; }
.badge-icon-txt { font-size: 0.8rem; font-weight: 800; color: #166534; }
.badge-lv-txt { font-size: 0.6rem; color: #22c55e; }
.member-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
.member-item { display: flex; justify-content: center; align-items: center; text-align: center; font-size: 0.75rem; font-weight: 700; padding: 10px 4px; border-radius: 10px; background: white; border: 1.5px solid #e2e8f0; cursor: pointer; transition: 0.15s; user-select: none; min-height: 48px; }
.member-item.selected { background: #3b82f6 !important; border-color: #1d4ed8 !important; color: white !important; }
.is-hidden { background: #f8fafc; border-color: #cbd5e1; opacity: 0.6; }
.hidden-txt { color: #ef4444; font-size: 0.55rem; font-weight: 800; display: block; }
.small-selector { display: flex; justify-content: space-around; background: #f8fafc; padding: 8px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 12px; }
.small-selector label { font-size: 0.8rem; font-weight: 800; display: flex; align-items: center; gap: 4px; cursor: pointer; }
.log-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 10px; }
.log-item-box { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 6px 0; display: flex; flex-direction: column; align-items: center; gap: 4px; }
.log-date-txt { font-size: 0.6rem; font-weight: 800; color: #64748b; }
.del-btn-mini { background: #fee2e2; color: #ef4444; width: 85%; padding: 2px 0; border-radius: 4px; font-size: 0.55rem; font-weight: 800; }
.sort-select { height: 40px; padding: 0 10px; font-size: 0.75rem; border-radius: 10px; border-color: #cbd5e1; width: auto !important; }
</style>
</head>
<body>
<div class="main-container">
<div class="tab-menu">
<button id="tabStatus" class="tab-btn active-tab" onclick="showView('status')">ğŸ“¡ ì‹¤ì‹œê°„ í˜„í™©</button>
<button id="tabAdmin" class="tab-btn" onclick="handleAdminTab()">ğŸ” ê´€ë¦¬ì</button>
</div>
<div id="viewStatus" class="view-content p-6">
<h1 class="text-xl font-extrabold mb-4 text-slate-800 flex items-center"><span class="green-blinking-emoji">â—</span> ì‹¤ì‹œê°„ ë“±ê¸‰í‘œ</h1>
<div class="flex gap-2 mb-4">
<input type="text" id="searchInput" onkeyup="renderStatusTable()" placeholder="ğŸ” ì´ë¦„ ê²€ìƒ‰..." class="h-10 px-4 rounded-xl flex-1 text-sm bg-gray-50 border-gray-200 outline-none">
<select id="statusSortOrder" onchange="renderStatusTable()" class="sort-select"><option value="qCount">ë¶„ê¸° íšŸìˆ˜ìˆœ</option><option value="level">ë ˆë²¨ ë†’ì€ìˆœ</option></select>
</div>
<div id="quarterTabs" class="flex gap-1 mb-6">
<button id="qBtn1" class="q-btn" onclick="changeQuarter(1)">1ë¶„ê¸°</button>
<button id="qBtn2" class="q-btn" onclick="changeQuarter(2)">2ë¶„ê¸°</button>
<button id="qBtn3" class="q-btn" onclick="changeQuarter(3)">3ë¶„ê¸°</button>
<button id="qBtn4" class="q-btn" onclick="changeQuarter(4)">4ë¶„ê¸°</button>
</div>
<table>
<thead><tr><th class="w-[25%] pr-[15px] text-right">íšŒì›ëª…</th><th class="w-[30%]">ë ˆë²¨(Lv)</th><th class="w-[20%]">ë¶„ê¸°íšŸìˆ˜</th><th class="w-[25%] pl-[10px] text-left">ê´€ë¦¬ë‚ ì§œ</th></tr></thead>
<tbody id="statusList"></tbody>
</table>
</div>
<div id="viewLogin" class="view-content hidden p-6 text-center"><div class="card py-12"><h2 class="font-bold mb-6">ê´€ë¦¬ì ì¸ì¦</h2><input type="password" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" class="input-gap text-center"><button onclick="loginAdmin()" class="btn-submit bg-blue-500">ì¸ì¦í•˜ê¸°</button></div></div>
<div id="viewAdmin" class="view-content hidden">
<div class="card"><div class="card-title text-green-600">ğŸ†• ì‹ ê·œ íšŒì› ë“±ë¡</div><input type="text" id="newName" placeholder="ì´ë¦„ ì…ë ¥" class="input-gap"><input type="date" id="regDate" class="input-gap"><button onclick="addMember()" class="btn-submit bg-green-500">ë“±ë¡ ì™„ë£Œ</button></div>
<div class="card"><div class="card-title text-blue-600">ğŸ“… ë“±ì‚° ê¸°ë¡ ì¶”ê°€</div><input type="text" id="adminSearchInput" onkeyup="filterAdminMemberList()" placeholder="ğŸ” íšŒì› ê²€ìƒ‰..." class="h-9 px-4 rounded-xl w-full mb-3 text-xs bg-blue-50 border-blue-100 outline-none"><div id="multiMemberList" class="max-h-80 overflow-y-auto border-0 p-1 mb-4 member-grid"></div><div class="small-selector text-blue-800"><label><input type="radio" name="upAmount" value="1" checked> 1up</label><label><input type="radio" name="upAmount" value="2"> 2up</label><label><input type="radio" name="upAmount" value="3"> 3up</label></div><input type="date" id="activityDate" class="input-gap"><button onclick="addMultiActivity()" class="btn-submit bg-blue-500">ê¸°ë¡ ì €ì¥í•˜ê¸°</button></div>
<div class="card" style="background-color: #fffdf0; border-color: #fef3c7;"><div class="card-title text-yellow-700">âœï¸ ë ˆë²¨ ì°¨ê° ë° ê¸°ë¡ ì‚­ì œ</div><select id="memberSelectEdit" onchange="loadMemberLogs()" class="input-gap"><option value="">ëŒ€ìƒ íšŒì› ì„ íƒ</option></select><div class="small-selector text-red-600"><label><input type="radio" name="downAmount" value="1" checked> -1</label><label><input type="radio" name="downAmount" value="2"> -2</label><label><input type="radio" name="downAmount" value="3"> -3</label></div><button onclick="onlyDownLevel()" class="w-full bg-orange-500 text-white py-2 rounded-lg font-black text-xs mb-3">ë ˆë²¨ë§Œ ì°¨ê°</button><div id="logListArea" class="log-grid"></div></div>
<div class="card" style="background-color: #fff5f5; border-color: #fee2e2;"><div class="card-title text-red-600">ğŸ—‘ï¸ íšŒì› ìƒíƒœ ê´€ë¦¬</div><select id="memberSelectManage" class="input-gap"><option value="">ëŒ€ìƒ íšŒì› ì„ íƒ</option></select><button onclick="toggleHideMember()" class="btn-submit bg-gray-600 mb-2 h-10 py-0 text-sm">ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°</button><button onclick="deleteMember()" class="btn-submit bg-red-500 h-10 py-0 text-sm">íšŒì› ì˜êµ¬ ì‚­ì œ</button></div>
<div class="p-8 text-center"><button onclick="logoutAdmin()" class="text-gray-400 underline font-bold text-sm">ë¡œê·¸ì•„ì›ƒ</button></div>
</div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, increment, query, orderBy, Timestamp, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
const firebaseConfig = { apiKey: "AIzaSyBoAh3V3WrHg_wo53g1LHM0UW3-y6w2deg", authDomain: "san-woori-db.firebaseapp.com", projectId: "san-woori-db", storageBucket: "san-woori-db.firebasestorage.app", messagingSenderId: "387585514110", appId: "1:387585514110:web:44749e6d92769fff6ad62f" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let isAdminLoggedIn = false; let currentData = []; let selectedQuarter = Math.ceil((new Date().getMonth() + 1) / 3); let selectedMemberIds = new Set();

const getLevelBadge = (lv) => { if (lv >= 100) return "ğŸŒŒ ì€í•˜ìˆ˜"; if (lv >= 90) return "ğŸŒ  ë³„ë˜¥ë³„"; if (lv >= 80) return "ğŸ’« íƒ€ì›ë³„"; if (lv >= 70) return "ğŸŒŸ í™©ê¸ˆë³„"; if (lv >= 60) return "â­ï¸ ë³„"; if (lv >= 50) return "â˜€ï¸ í•´"; if (lv >= 45) return "ğŸŒ• ë‹¬"; if (lv >= 40) return "ğŸŒ™ ì´ˆìŠ¹ë‹¬"; if (lv >= 35) return "â˜„ï¸ ìš´ì„"; if (lv >= 30) return "ğŸŒˆ ë¬´ì§€ê°œ"; if (lv >= 25) return "ğŸŒ€ íƒœí’"; if (lv >= 20) return "ğŸŒ‹ í™”ì‚°"; if (lv >= 15) return "ğŸ”ï¸ ì„¤ì‚°"; if (lv >= 10) return "â›°ï¸ ì‚°"; if (lv >= 5) return "ğŸŒ³ ë‚˜ë¬´"; if (lv >= 3) return "ğŸŒ¿ í’€ì"; if (lv >= 1) return "ğŸŒ± ìƒˆì‹¹"; return "ğŸ£ ì‹ ì…"; };
window.showView = (v) => { document.querySelectorAll('.view-content').forEach(e => e.classList.add('hidden')); document.getElementById('view'+v.charAt(0).toUpperCase()+v.slice(1)).classList.remove('hidden'); };
window.handleAdminTab = () => isAdminLoggedIn ? showView('admin') : showView('login');
window.loginAdmin = () => { if(document.getElementById('adminPassword').value === "1221") { isAdminLoggedIn = true; showView('admin'); } else alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); };
window.logoutAdmin = () => { isAdminLoggedIn = false; document.getElementById('adminPassword').value=""; showView('status'); };
window.changeQuarter = (q) => { selectedQuarter = q; document.querySelectorAll('.q-btn').forEach((btn, idx) => btn.classList.toggle('active-q', idx + 1 === q)); startRealtimeSync(); };

// âœ… ë‚ ì§œ ê³„ì‚° ë¡œì§: 24ì‹œ ìì • ê¸°ì¤€ ìë™ ê°±ì‹  ì—”ì§„
window.renderStatusTable = () => {
    const list = document.getElementById('statusList');
    const searchTerm = document.getElementById('searchInput').value.trim();
    const sortKey = document.getElementById('statusSortOrder').value;
    list.innerHTML = "";
    
    // í˜„ì¬ í•œêµ­ ì‹œê°„ ê¸°ì¤€ 'ë‚ ì§œ'ë§Œ ì¶”ì¶œ (ì‹œê°„/ë¶„/ì´ˆ ì œê±°)
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    const displayData = [...currentData].sort((a, b) => { 
        if (sortKey === 'qCount') return b.qCount - a.qCount || b.level - a.level; 
        return b.level - a.level || b.qCount - a.qCount; 
    });

    displayData.filter(m => !m.isHidden && m.name.includes(searchTerm)).forEach((m) => {
        // DBì— ì €ì¥ëœ ë‚ ì§œë„ 'ë‚ ì§œ' ì •ë³´ë§Œ ì¶”ì¶œ (00:00:00ë¡œ ë¦¬ì…‹)
        const d = m.lastDate.toDate();
        const recordDay = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        
        // ë‚ ì§œ ì°¨ì´ ê³„ì‚° (ë°€ë¦¬ì´ˆ ì°¨ì´ë¥¼ í•˜ë£¨ì¹˜ ë°€ë¦¬ì´ˆë¡œ ë‚˜ëˆ”)
        const diffMs = today.getTime() - recordDay.getTime();
        const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
        
        // ê¸°ì¤€ê°’ ì ìš© (ì‹ ì… 30ì¼, ì¼ë°˜ 122ì¼)
        const base = (m.level === 0 ? 30 : 122);
        const dday = base - diffDays;
        const ddayTxt = dday >= 0 ? `D-${dday}` : `+${Math.abs(dday)}ì¼`;

        list.innerHTML += `<tr class="border-b border-gray-50 text-sm"><td class="text-[11px] pr-2"><span>${m.name}</span></td><td><div class="badge-level"><span class="badge-icon-txt">${getLevelBadge(m.level)}</span><span class="badge-lv-txt">Lv ${m.level}</span></div></td><td>${m.qCount}íšŒ</td><td class="text-left pl-2 text-[10px] ${dday<=10?'text-red-500 font-black':'text-gray-400'}">${ddayTxt}</td></tr>`;
    });
};

let unsubscribe = null;
function startRealtimeSync() {
if (unsubscribe) unsubscribe();
unsubscribe = onSnapshot(collection(db, "sanwoori"), async (snapshot) => {
const tempDocs = [];
const startDate = Timestamp.fromDate(new Date(2026, (selectedQuarter - 1) * 3, 1));
const endDate = Timestamp.fromDate(new Date(2026, selectedQuarter * 3, 1));
for (const d of snapshot.docs) {
const m = { id: d.id, ...d.data() };
const logsSnap = await getDocs(query(collection(db, `sanwoori/${m.id}/logs`), where("date", ">=", startDate), where("date", "<", endDate)));
m.qCount = logsSnap.size;
tempDocs.push(m);
}
const alphaSorted = [...tempDocs].sort((a, b) => a.name.localeCompare(b.name, 'ko'));
const multiList = document.getElementById('multiMemberList');
const editSelect = document.getElementById('memberSelectEdit');
const manageSelect = document.getElementById('memberSelectManage');
multiList.innerHTML = ""; editSelect.innerHTML = manageSelect.innerHTML = '<option value="">ëŒ€ìƒ íšŒì› ì„ íƒ</option>';
for (const m of alphaSorted) {
const hideCls = m.isHidden ? 'is-hidden' : ''; const hideTag = m.isHidden ? '<span class="hidden-txt">(ìˆ¨ê¹€)</span>' : ''; const isSel = selectedMemberIds.has(m.id) ? 'selected' : '';
multiList.innerHTML += `<div class="member-item ${hideCls} ${isSel}" onclick="toggleMemberSelection('${m.id}', this)"><span>${m.name}${hideTag}</span></div>`;
const optTxt = `${m.name}${m.isHidden ? ' (ìˆ¨ê¹€)' : ''}`; editSelect.innerHTML += `<option value="${m.id}">${optTxt}</option>`; manageSelect.innerHTML += `<option value="${m.id}">${optTxt}</option>`;
}
currentData = tempDocs; renderStatusTable();
});
}

window.addMultiActivity = async () => {
if(!selectedMemberIds.size) return alert("íšŒì› ì„ íƒ");
const dt = document.getElementById('activityDate').value; const up = parseInt(document.querySelector('input[name="upAmount"]:checked').value);
const ts = Timestamp.fromDate(dt ? new Date(dt + "T00:00:00") : new Date());
for (const mId of selectedMemberIds) {
await updateDoc(doc(db, "sanwoori", mId), { level: increment(up), lastDate: ts });
for(let i=0; i<up; i++) await addDoc(collection(db, `sanwoori/${mId}/logs`), { date: ts });
}
selectedMemberIds.clear(); startRealtimeSync();
};

window.deleteLog = async (mId, logId) => {
const dn = parseInt(document.querySelector('input[name="downAmount"]:checked').value);
if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
await deleteDoc(doc(db, `sanwoori/${mId}/logs`, logId));
await updateDoc(doc(db, "sanwoori", mId), { level: increment(-dn) });
const latestLogSnap = await getDocs(query(collection(db, `sanwoori/${mId}/logs`), orderBy("date", "desc"), limit(1)));
if (!latestLogSnap.empty) await updateDoc(doc(db, "sanwoori", mId), { lastDate: latestLogSnap.docs[0].data().date });
loadMemberLogs();
};

window.addMember = async () => {
const name = document.getElementById('newName').value; const date = document.getElementById('regDate').value;
if(name) { 
const ts = Timestamp.fromDate(date ? new Date(date + "T00:00:00") : new Date());
const newDoc = await addDoc(collection(db, "sanwoori"), { name, level: 0, lastDate: ts, isHidden: false }); 
await addDoc(collection(db, `sanwoori/${newDoc.id}/logs`), { date: ts });
document.getElementById('newName').value = ""; 
}
};

window.toggleHideMember = async () => { const id = document.getElementById('memberSelectManage').value; if(id) { const m = currentData.find(x => x.id === id); await updateDoc(doc(db, "sanwoori", id), { isHidden: !m.isHidden }); } };
window.deleteMember = async () => { const id = document.getElementById('memberSelectManage').value; if(id && confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, "sanwoori", id)); };
window.onlyDownLevel = async () => { const id = document.getElementById('memberSelectEdit').value; const dn = parseInt(document.querySelector('input[name="downAmount"]:checked').value); if(id) await updateDoc(doc(db, "sanwoori", id), { level: increment(-dn) }); };
window.loadMemberLogs = async () => { const id = document.getElementById('memberSelectEdit').value; const area = document.getElementById('logListArea'); area.innerHTML = ""; if(!id) return; const snap = await getDocs(query(collection(db, `sanwoori/${id}/logs`), orderBy("date", "desc"))); snap.forEach(ld => { const d = ld.data().date.toDate(); area.innerHTML += `<div class="log-item-box"><span class="log-date-txt">${d.getMonth()+1}.${d.getDate()}</span><button class="del-btn-mini" onclick="deleteLog('${id}', '${ld.id}')">ì‚­ì œ</button></div>`; }); };
window.toggleMemberSelection = (id, el) => { if (selectedMemberIds.has(id)) { selectedMemberIds.delete(id); el.classList.remove('selected'); } else { selectedMemberIds.add(id); el.classList.add('selected'); } };
window.filterAdminMemberList = () => { const q = document.getElementById('adminSearchInput').value.toLowerCase(); document.querySelectorAll('.member-item').forEach(i => i.style.display = i.innerText.toLowerCase().includes(q) ? "flex" : "none"); };

document.getElementById('regDate').valueAsDate = new Date();
document.getElementById('activityDate').valueAsDate = new Date();
changeQuarter(selectedQuarter);
</script>
</body>
</html>
