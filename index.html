<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‚°:ìš°ë¦¬ - ë ˆë²¨ ì‹œìŠ¤í…œ</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
body { font-family: 'Pretendard', sans-serif; background-color: #f4f7f9; color: #333; }
.main-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.05); }

/* ê³µí†µ ìŠ¤íƒ€ì¼ */
input, select, .btn-submit { width: 100%; display: block; padding: 12px 16px; border-radius: 12px; font-size: 0.95rem; height: 52px; border: 1.5px solid #e2e8f0; outline: none; box-sizing: border-box; }
.input-gap { margin-bottom: 16px; }
.btn-submit { font-weight: 800; color: white; border: none; cursor: pointer; transition: 0.2s; margin-top: 10px; }

/* íƒ­ ë©”ë‰´ */
.tab-menu { display: flex; background: #f8fafc; padding: 12px; gap: 10px; border-bottom: 1px solid #e2e8f0; }
.tab-btn { flex: 1; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 0.95rem; border: 1px solid #e2e8f0; background: white; color: #64748b; }
.active-tab { background: #3b82f6; color: white; border: none; }

/* ì‹œí¬ë¦¿ ì„œë¸Œë°© ìŠ¤íƒ€ì¼ */
.subroom-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 30px; }
.room-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 12px; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
.room-card:active { transform: scale(0.95); }
.room-card.in-use { border-color: #ef4444; background: rgba(239, 68, 68, 0.05); animation: room-glow 2s infinite; }
.room-status-dot { width: 6px; height: 6px; border-radius: 50%; background: #475569; position: absolute; top: 12px; right: 12px; }
.in-use .room-status-dot { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
.room-emoji { font-size: 1.2rem; margin-bottom: 4px; display: block; }
.room-name { color: #f1f5f9; font-size: 0.85rem; font-weight: 800; }
.room-desc { color: #94a3b8; font-size: 0.65rem; margin-top: 2px; }
.in-use .room-desc { color: #fca5a5; font-weight: 700; }

@keyframes room-glow { 0%, 100% { box-shadow: inset 0 0 0px rgba(239, 68, 68, 0); } 50% { box-shadow: inset 0 0 10px rgba(239, 68, 68, 0.2); } }

/* ê´€ë¦¬ì ëª¨ë“œ - ì„œë¸Œë°© ì„¤ì • */
.admin-room-item { background: #f8fafc; border-radius: 12px; padding: 12px; border: 1px solid #e2e8f0; margin-bottom: 8px; }
.toggle-btn { padding: 6px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; transition: 0.2s; }
.toggle-off { background: #e2e8f0; color: #64748b; }
.toggle-on { background: #ef4444; color: white; }

/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
.main-title { font-size: 1.5rem; font-weight: 900; background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; }
.badge-level { display: inline-flex; flex-direction: column; align-items: center; }
.badge-icon-box { padding: 2px 8px; border-radius: 14px; border-width: 1.5px; min-width: 50px; text-align: center; }
.dday-box { padding: 4px 8px; border-radius: 8px; font-weight: 800; font-size: 11px; min-width: 55px; display: inline-block; }
.secret-login-container { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); border-radius: 24px; padding: 30px 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); }
.secret-input { background: rgba(255, 255, 255, 0.05) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; color: white !important; text-align: center; }

/* ì• ë‹ˆë©”ì´ì…˜ ë° ë“±ê¸‰ ì»¬ëŸ¬ */
.dday-red { background-color: #fecaca; color: #991b1b; animation: blink-fast 0.6s infinite; }
@keyframes blink-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
.level-blink-red { animation: glow-red 1.2s infinite ease-in-out; }
@keyframes glow-red { 0%, 100% { border-color: #ef4444; } 50% { box-shadow: 0 0 10px rgba(185, 28, 28, 0.6); } }
</style>
</head>
<body>

<div class="main-container">
    <div class="tab-menu">
        <button id="tabStatus" class="tab-btn active-tab" onclick="showView('status')">ğŸ“¡ ì‹¤ì‹œê°„ í˜„í™©</button>
        <button id="tabAdmin" class="tab-btn" onclick="handleAdminTab()">ğŸ” ê´€ë¦¬ì ì„¤ì •</button>
    </div>

    <div id="viewStatus" class="view-content p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="main-title"><img src="https://i.ibb.co/3mHmBPXd/1770301184544.png" class="h-6 mr-2">ì‚°:ìš°ë¦¬</h1>
            <select id="yearSelect" onchange="changeYear()" class="text-xs font-bold bg-gray-100 p-1 rounded">
                <option value="2026">2026ë…„</option>
                <option value="2027">2027ë…„</option>
            </select>
        </div>
        
        <div class="flex gap-2 mb-4">
            <input type="text" id="searchInput" onkeyup="renderStatusTable()" placeholder="ğŸ” ê²€ìƒ‰..." class="h-10 text-sm flex-grow rounded-xl border-gray-200">
            <button onclick="toggleModal(true)" class="bg-slate-100 px-3 rounded-xl text-xs font-bold">ğŸ“Š ë“±ê¸‰</button>
        </div>

        <div id="quarterTabs" class="flex gap-1 mb-4 bg-gray-100 p-1 rounded-full">
            <button class="q-btn flex-1 py-1 text-[10px] font-bold rounded-full active-q" onclick="changeQuarter(1)">1ë¶„ê¸°</button>
            <button class="q-btn flex-1 py-1 text-[10px] font-bold rounded-full" onclick="changeQuarter(2)">2ë¶„ê¸°</button>
            <button class="q-btn flex-1 py-1 text-[10px] font-bold rounded-full" onclick="changeQuarter(3)">3ë¶„ê¸°</button>
            <button class="q-btn flex-1 py-1 text-[10px] font-bold rounded-full" onclick="changeQuarter(4)">4ë¶„ê¸°</button>
        </div>

        <table class="w-full text-center">
            <thead>
                <tr class="text-[10px] text-gray-400 border-b">
                    <th class="py-2">íšŒì›</th><th class="py-2">ë ˆë²¨</th><th class="py-2">ë¶„ê¸°</th><th class="py-2">ë‚¨ì€ë‚ </th>
                </tr>
            </thead>
            <tbody id="statusList"></tbody>
        </table>
    </div>

    <div id="viewLogin" class="view-content hidden p-6">
        <div class="secret-login-container">
            <div class="text-center mb-6">
                <span class="text-3xl">ğŸŒŒ</span>
                <h2 class="text-white text-lg font-black mt-2">SECRET SUB-ROOMS</h2>
                <p class="text-blue-400 text-[10px] tracking-widest opacity-60">ë³µì‚¬í•˜ë ¤ë©´ ë°©ì„ í´ë¦­í•˜ì„¸ìš”</p>
            </div>

            <div id="subRoomDisplay" class="subroom-grid">
                </div>

            <div class="border-t border-white/10 pt-8">
                <input type="password" id="adminPassword" placeholder="ADMIN PASSWORD" class="secret-input input-gap">
                <button onclick="loginAdmin()" class="btn-submit bg-blue-600">ACCESS GRANTED</button>
            </div>
        </div>
    </div>

    <div id="viewAdmin" class="view-content hidden p-6">
        <div class="bg-slate-900 text-white p-5 rounded-2xl mb-6">
            <h3 class="font-black text-sm mb-4 flex items-center gap-2">âš™ï¸ ì„œë¸Œë°© ì‹¤ì‹œê°„ ê´€ë¦¬</h3>
            <div id="adminRoomList" class="space-y-2">
                </div>
        </div>

        <div class="bg-white border p-4 rounded-xl mb-4">
            <h3 class="font-bold text-green-600 mb-2">ğŸ†• ì‹ ê·œ ë“±ë¡</h3>
            <input type="text" id="newName" placeholder="ì´ë¦„" class="h-10 mb-2 border rounded-lg px-3 w-full">
            <input type="date" id="regDate" class="h-10 mb-2 border rounded-lg px-3 w-full">
            <button onclick="addMember()" class="w-full bg-green-500 text-white h-10 rounded-lg font-bold">ë“±ë¡</button>
        </div>

        <div class="bg-white border p-4 rounded-xl mb-4">
            <h3 class="font-bold text-blue-600 mb-2">ğŸ“… ë“±ì‚° ê¸°ë¡</h3>
            <div id="multiMemberList" class="grid grid-cols-3 gap-1 max-h-40 overflow-y-auto mb-3"></div>
            <div class="flex gap-2 mb-3">
                <input type="date" id="activityDate" class="h-10 border rounded-lg px-3 flex-1">
                <select id="upAmount" class="h-10 border rounded-lg px-2 w-20">
                    <option value="1">1up</option><option value="2">2up</option><option value="3">3up</option>
                </select>
            </div>
            <button onclick="addMultiActivity()" class="w-full bg-blue-500 text-white h-10 rounded-lg font-bold">ê¸°ë¡ ì €ì¥</button>
        </div>

        <div class="text-center py-4">
            <button onclick="logoutAdmin()" class="text-gray-400 underline text-xs">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
</div>

<div id="levelModal" class="modal-overlay fixed inset-0 bg-black/50 hidden items-center justify-center p-6 z-50">
    <div class="bg-white rounded-3xl p-6 w-full max-w-sm">
        <div id="levelGuideGrid" class="grid grid-cols-3 gap-3"></div>
        <button onclick="toggleModal(false)" class="w-full mt-4 py-3 bg-gray-800 text-white rounded-xl font-bold">ë‹«ê¸°</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, increment, query, orderBy, Timestamp, where, getDocs, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBoAh3V3WrHg_wo53g1LHM0UW3-y6w2deg",
    authDomain: "san-woori-db.firebaseapp.com",
    projectId: "san-woori-db",
    storageBucket: "san-woori-db.firebasestorage.app",
    messagingSenderId: "387585514110",
    appId: "1:387585514110:web:44749e6d92769fff6ad62f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- ìƒíƒœ ê´€ë¦¬ ë° ë°ì´í„° ---
let currentData = [];
let isAdminLoggedIn = false;
let selectedYear = new Date().getFullYear();
let selectedQuarter = Math.ceil((new Date().getMonth() + 1) / 3);
let selectedMemberIds = new Set();

const roomsData = [
    { id: 'shop', name: 'ìƒì ', emoji: 'ğŸ›’', link: 'https://open.kakao.com/o/gYPcpN3h' },
    { id: 'blacksmith', name: 'ëŒ€ì¥ê°„', emoji: 'âš’ï¸', link: 'https://open.kakao.com/o/gxAupN3h' },
    { id: 'inn', name: 'ì—¬ê´€', emoji: 'ğŸ¡', link: 'https://open.kakao.com/o/g1EyoN3h' },
    { id: 'storage', name: 'ì°½ê³ ', emoji: 'ğŸ“¦', link: 'https://open.kakao.com/o/gxYloN3h' },
    { id: 'training', name: 'í›ˆë ¨ì†Œ', emoji: 'âš”ï¸', link: 'https://open.kakao.com/o/gDqYnN3h' },
    { id: 'weapon', name: 'ë¬´ê¸°ì ', emoji: 'ğŸ—¡ï¸', link: 'https://open.kakao.com/o/gbq0qz6h' },
    { id: 'magic', name: 'ë§ˆë²•ìƒì ', emoji: 'ğŸ”®', link: 'https://open.kakao.com/o/g0p4sz6h' },
    { id: 'general', name: 'ì¡í™”ì ', emoji: 'ğŸº', link: 'https://open.kakao.com/o/gW3urz6h' },
    { id: 'bank', name: 'ì€í–‰', emoji: 'ğŸ’°', link: 'https://open.kakao.com/o/gIiWrz6h' },
    { id: 'stable', name: 'ìŠ¹ë§ˆì¥', emoji: 'ğŸ', link: 'https://open.kakao.com/o/gYiVoN3h' }
];

// --- ì„œë¸Œë°© ì‹¤ì‹œê°„ ì—°ë™ ---
function listenRooms() {
    onSnapshot(doc(db, "admin_settings", "rooms"), (s) => {
        const status = s.exists() ? s.data() : {};
        renderSubRooms(status);
        if(isAdminLoggedIn) renderAdminRooms(status);
    });
}

function renderSubRooms(status) {
    const container = document.getElementById('subRoomDisplay');
    container.innerHTML = "";
    roomsData.forEach(room => {
        const isUse = status[room.id]?.isUse || false;
        const desc = status[room.id]?.desc || "ëŒ€ê¸° ì¤‘";
        container.innerHTML += `
            <div class="room-card ${isUse ? 'in-use' : ''}" onclick="copyLink('${room.link}', '${room.name}')">
                <div class="room-status-dot"></div>
                <span class="room-emoji">${room.emoji}</span>
                <div class="room-name">${room.name}</div>
                <div class="room-desc">${isUse ? 'ğŸ”´ ' + desc : desc}</div>
            </div>`;
    });
}

function renderAdminRooms(status) {
    const container = document.getElementById('adminRoomList');
    container.innerHTML = "";
    roomsData.forEach(room => {
        const isUse = status[room.id]?.isUse || false;
        const desc = status[room.id]?.desc || "";
        container.innerHTML += `
            <div class="admin-room-item flex items-center gap-2">
                <span class="text-lg w-6">${room.emoji}</span>
                <input type="text" id="desc_${room.id}" value="${desc}" placeholder="ë°© ìš©ë„ ì…ë ¥" 
                    class="flex-1 h-8 bg-white border rounded px-2 text-black text-xs">
                <button onclick="toggleRoom('${room.id}', ${isUse})" 
                    class="toggle-btn ${isUse ? 'toggle-on' : 'toggle-off'}">
                    ${isUse ? 'ì‚¬ìš©ì¤‘' : 'ì‚¬ìš©ì•ˆí•¨'}
                </button>
            </div>`;
    });
}

window.copyLink = (link, name) => {
    navigator.clipboard.writeText(link);
    alert(`[${name}] ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
};

window.toggleRoom = async (roomId, currentStatus) => {
    const desc = document.getElementById(`desc_${roomId}`).value;
    await updateDoc(doc(db, "admin_settings", "rooms"), {
        [`${roomId}.isUse`]: !currentStatus,
        [`${roomId}.desc`]: desc
    });
};

// --- ê¸°ì¡´ í•µì‹¬ ë¡œì§ (Firebase ì—°ë™) ---
const levelThresholds = [
    { lv: 100, name: "ğŸŒŒ ì€í•˜ìˆ˜" }, { lv: 50, name: "â˜€ï¸ í•´" }, { lv: 10, name: "â›°ï¸ ì‚°" }, { lv: 0, name: "ğŸ«˜ ì‹ ì…" }
];

function getLevelBadge(lv) { return levelThresholds.find(t => lv >= t.lv)?.name || "ğŸ«˜ ì‹ ì…"; }

window.startRealtimeSync = () => {
    onSnapshot(collection(db, "sanwoori"), async (snapshot) => {
        const start = Timestamp.fromDate(new Date(selectedYear, (selectedQuarter - 1) * 3, 1));
        const end = Timestamp.fromDate(new Date(selectedYear, selectedQuarter * 3, 1));
        
        const results = await Promise.all(snapshot.docs.map(async (docSnap) => {
            const m = { id: docSnap.id, ...docSnap.data() };
            const lSnap = await getDocs(query(collection(db, `sanwoori/${m.id}/logs`), where("date", ">=", start), where("date", "<", end)));
            m.qCount = lSnap.size;
            return m;
        }));
        currentData = results;
        renderStatusTable();
        updateAdminMemberLists();
    });
};

window.renderStatusTable = () => {
    const list = document.getElementById('statusList');
    const search = document.getElementById('searchInput').value;
    list.innerHTML = "";
    
    currentData.forEach(m => {
        if(search && !m.name.includes(search)) return;
        const last = m.lastDate.toDate();
        const diff = Math.floor((new Date() - last) / (1000*60*60*24));
        const dday = (m.level === 0 ? 30 : 122) + (m.bonusDays || 0) - diff;

        list.innerHTML += `
            <tr class="border-b text-xs">
                <td class="py-4 font-bold">${m.name}</td>
                <td><span class="badge-icon-box bg-slate-50 border-slate-200 text-slate-600">${getLevelBadge(m.level)}</span></td>
                <td class="font-bold">${m.qCount}íšŒ</td>
                <td><span class="dday-box ${dday <= 10 ? 'dday-red' : 'bg-gray-100'}">D-${dday}</span></td>
            </tr>`;
    });
};

// --- í™”ë©´ ì œì–´ ---
window.showView = (v) => {
    document.querySelectorAll('.view-content').forEach(e => e.classList.add('hidden'));
    document.getElementById('view' + v.charAt(0).toUpperCase() + v.slice(1)).classList.remove('hidden');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
    if(v === 'status') document.getElementById('tabStatus').classList.add('active-tab');
    else document.getElementById('tabAdmin').classList.add('active-tab');
};

window.handleAdminTab = () => isAdminLoggedIn ? showView('admin') : showView('login');

window.loginAdmin = async () => {
    const pw = document.getElementById('adminPassword').value;
    const s = await getDoc(doc(db, "admin_settings", "config"));
    if(s.exists() && pw === String(s.data().admin_pw)) {
        isAdminLoggedIn = true;
        showView('admin');
        listenRooms(); // ê´€ë¦¬ì ëª¨ë“œìš© ë¦¬ìŠ¤ë„ˆ ì¬í™œì„±
    } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    }
};

window.logoutAdmin = () => {
    isAdminLoggedIn = false;
    showView('status');
};

// ì´ˆê¸°í™”
listenRooms();
startRealtimeSync();

// --- ë©¤ë²„ ê´€ë¦¬ ê¸°ëŠ¥ë“¤ (ë²„íŠ¼ ì—°ê²°ìš©) ---
window.updateAdminMemberLists = () => {
    const grid = document.getElementById('multiMemberList');
    grid.innerHTML = "";
    currentData.forEach(m => {
        const div = document.createElement('div');
        div.className = `p-2 text-[10px] border rounded text-center cursor-pointer ${selectedMemberIds.has(m.id) ? 'bg-blue-500 text-white' : 'bg-white'}`;
        div.innerText = m.name;
        div.onclick = () => {
            if(selectedMemberIds.has(m.id)) selectedMemberIds.delete(m.id);
            else selectedMemberIds.add(m.id);
            updateAdminMemberLists();
        };
        grid.appendChild(div);
    });
};

window.addMember = async () => {
    const name = document.getElementById('newName').value;
    const date = document.getElementById('regDate').value;
    if(!name || !date) return;
    await addDoc(collection(db, "sanwoori"), {
        name, level: 0, lastDate: Timestamp.fromDate(new Date(date)), isHidden: false, bonusDays: 0
    });
    alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
};
</script>
</body>
</html>
