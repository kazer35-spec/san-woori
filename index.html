<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚°:ìš°ë¦¬ - ë“±ì‚° ë ˆë²¨ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .main-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative; }

        /* ê³µí†µ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        input, select, .btn-submit { width: 100% !important; display: block; padding: 12px 16px; border-radius: 14px; font-size: 0.95rem; height: 52px; border: 1.5px solid #e2e8f0; outline: none; transition: 0.3s; }
        input:focus { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .btn-submit { font-weight: 800; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* ì—°ë„/ë¶„ê¸° ì„ íƒ íƒ­ */
        .selector-container { background: #f1f5f9; padding: 6px; border-radius: 16px; margin-bottom: 12px; }
        .tab-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        .tab-btn-item { padding: 8px 0; border-radius: 10px; font-size: 0.75rem; font-weight: 700; color: #64748b; transition: 0.2s; background: transparent; }
        .tab-btn-item.active { background: white; color: #2563eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* ë©”ì¸ ìƒë‹¨ íƒ­ */
        .top-nav { display: flex; padding: 16px; gap: 10px; background: white; border-bottom: 1px solid #f1f5f9; position: sticky; top: 0; z-index: 50; }
        .nav-btn { flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; font-size: 0.9rem; transition: 0.2s; }
        .nav-btn.active { background: #2563eb; color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .nav-btn.inactive { background: #f8fafc; color: #94a3b8; }

        /* ì¹´ë“œ ë° í…Œì´ë¸” */
        .card { background: white; border-radius: 24px; border: 1px solid #f1f5f9; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { color: #94a3b8; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; padding: 0 10px 10px; }
        td { background: white; padding: 16px 10px; vertical-align: middle; border-top: 1px solid #f8fafc; border-bottom: 1px solid #f8fafc; }
        tr td:first-child { border-left: 1px solid #f8fafc; border-top-left-radius: 16px; border-bottom-left-radius: 16px; }
        tr td:last-child { border-right: 1px solid #f8fafc; border-top-right-radius: 16px; border-bottom-right-radius: 16px; }

        /* ë ˆë²¨ ë±ƒì§€ ë° ì• ë‹ˆë©”ì´ì…˜ */
        .badge-box { padding: 4px 10px; border-radius: 12px; border-width: 1.5px; display: inline-flex; flex-direction: column; align-items: center; min-width: 65px; }
        @keyframes pulse-glow { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.02); opacity: 0.8; } }
        .glow-active { animation: pulse-glow 2s infinite ease-in-out; }

        /* ê´€ë¦¬ì ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .member-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-height: 250px; overflow-y: auto; padding: 4px; }
        .chip { padding: 10px 4px; border: 1.5px solid #e2e8f0; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-align: center; cursor: pointer; transition: 0.2s; }
        .chip.selected { background: #2563eb; color: white; border-color: #2563eb; transform: translateY(-2px); }

        /* D-Day ê²½ê³  ìƒ‰ìƒ */
        .dday-red { color: #ef4444; font-weight: 900; animation: blink 1s infinite; }
        .dday-orange { color: #f97316; font-weight: 800; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="main-container">
    <div class="top-nav">
        <button id="btnStatus" class="nav-btn active" onclick="showView('status')">ğŸ“Š ì‹¤ì‹œê°„ í˜„í™©</button>
        <button id="btnAdmin" class="nav-btn inactive" onclick="handleAdminTab()">ğŸ” ê´€ë¦¬ì ì„¤ì •</button>
    </div>

    <div id="viewStatus" class="p-5">
        <header class="mb-6">
            <h1 class="text-2xl font-black tracking-tight text-slate-800">
                ì‚°:ìš°ë¦¬ <span class="text-blue-600" id="currentYearTitle">2026</span>
            </h1>
            <p class="text-xs text-slate-400 font-medium">ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ëŠ” ë“±ì‚° ë ˆë²¨ í˜„í™©</p>
        </header>

        <div class="selector-container">
            <div id="yearTabs" class="tab-grid mb-2">
                <button class="tab-btn-item" onclick="changeYear(2024)">2024ë…„</button>
                <button class="tab-btn-item" onclick="changeYear(2025)">2025ë…„</button>
                <button class="tab-btn-item active" onclick="changeYear(2026)">2026ë…„</button>
                <button class="tab-btn-item" onclick="changeYear(2027)">2027ë…„</button>
            </div>
            <div id="quarterTabs" class="tab-grid">
                <button class="tab-btn-item" onclick="changeQuarter(1)">1ë¶„ê¸°</button>
                <button class="tab-btn-item" onclick="changeQuarter(2)">2ë¶„ê¸°</button>
                <button class="tab-btn-item" onclick="changeQuarter(3)">3ë¶„ê¸°</button>
                <button class="tab-btn-item" onclick="changeQuarter(4)">4ë¶„ê¸°</button>
            </div>
        </div>

        <div class="flex gap-2 mb-6 h-11">
            <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." class="flex-[2] !h-full text-sm bg-slate-50 border-none">
            <select id="sortOrder" onchange="renderTable()" class="flex-1 !h-full text-xs font-bold border-none bg-slate-100">
                <option value="qCount">ë¶„ê¸°ìˆœ â–¼</option>
                <option value="level">ë ˆë²¨ìˆœ â–¼</option>
                <option value="name">ì´ë¦„ìˆœ</option>
            </select>
        </div>

        <table>
            <thead>
                <tr>
                    <th class="w-[30%]">ë©¤ë²„</th>
                    <th class="w-[35%]">ë“±ê¸‰</th>
                    <th class="w-[15%]">ê¸°ë¡</th>
                    <th class="w-[20%]">ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody id="statusList"></tbody>
        </table>
    </div>

    <div id="viewLogin" class="hidden p-10 text-center">
        <div class="card border-dashed border-2 py-16">
            <div class="text-4xl mb-4">ğŸ”</div>
            <h2 class="text-xl font-bold mb-6">ê´€ë¦¬ì ì¸ì¦</h2>
            <input type="password" id="adminPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="text-center mb-4">
            <button onclick="loginAdmin()" class="btn-submit bg-slate-900 w-full">ì¸ì¦ ë° ì ‘ì†</button>
        </div>
    </div>

    <div id="viewAdmin" class="hidden p-5">
        <div class="card border-blue-100">
            <div class="flex items-center gap-2 mb-4 font-black text-blue-600">
                <span class="w-2 h-2 bg-blue-600 rounded-full"></span> í™œë™ ê¸°ë¡ ì¶”ê°€
            </div>
            <input type="text" id="adminSearch" onkeyup="filterAdminMembers()" placeholder="íšŒì› í•„í„°ë§..." class="!h-10 text-xs mb-3">
            <div id="adminMemberList" class="member-grid mb-4"></div>
            
            <div class="flex gap-2 mb-4">
                <select id="upAmount" class="!h-12 font-bold text-blue-600 border-blue-200">
                    <option value="1">1 Step Up</option>
                    <option value="2">2 Step Up</option>
                    <option value="3">3 Step Up</option>
                </select>
                <input type="date" id="activityDate" class="!h-12 text-sm">
            </div>
            <button onclick="addActivity()" class="btn-submit bg-blue-600 shadow-lg shadow-blue-100">ê¸°ë¡ ì¼ê´„ ì €ì¥</button>
        </div>

        <div class="card border-amber-100">
            <div class="flex items-center gap-2 mb-4 font-black text-amber-600">
                <span class="w-2 h-2 bg-amber-600 rounded-full"></span> ë°ì´í„° ë³´ì • ë° í¸ì§‘
            </div>
            <select id="editMemberSelect" onchange="loadLogs()" class="mb-3">
                <option value="">í¸ì§‘í•  ë©¤ë²„ ì„ íƒ</option>
            </select>
            <div id="editControls" class="hidden">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="editNameInput" placeholder="ì´ë¦„ ë³€ê²½" class="!h-10 text-sm">
                    <button onclick="updateName()" class="bg-amber-500 text-white px-4 rounded-xl text-xs font-bold">ë³€ê²½</button>
                </div>
                <div id="logContainer" class="grid grid-cols-4 gap-2 mb-4"></div>
                <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                    <p class="text-[10px] text-red-400 font-bold mb-2">ë³´ë„ˆìŠ¤ ë‚ ì§œ ë¶€ì—¬ (D-Day ì—°ì¥)</p>
                    <div class="flex gap-2">
                        <input type="number" id="bonusInput" class="!h-10 text-sm" placeholder="ì¼ìˆ˜">
                        <button onclick="updateBonus()" class="bg-red-500 text-white px-4 rounded-xl text-xs font-bold">ì ìš©</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="flex items-center gap-2 mb-4 font-black text-emerald-600">
                <span class="w-2 h-2 bg-emerald-600 rounded-full"></span> ì‹ ê·œ ë©¤ë²„ ë“±ë¡
            </div>
            <div class="flex gap-2">
                <input type="text" id="newName" placeholder="ì´ë¦„" class="!h-12">
                <input type="date" id="joinDate" class="!h-12 text-sm">
            </div>
            <button onclick="registerMember()" class="btn-submit bg-emerald-600 mt-3">ì‹ ê·œ ë“±ë¡</button>
        </div>

        <button onclick="logout()" class="w-full py-4 text-slate-400 font-bold text-sm underline">ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, increment, query, orderBy, Timestamp, where, getDocs, getDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBoAh3V3WrHg_wo53g1LHM0UW3-y6w2deg",
        authDomain: "san-woori-db.firebaseapp.com",
        projectId: "san-woori-db",
        storageBucket: "san-woori-db.firebasestorage.app",
        messagingSenderId: "387585514110",
        appId: "1:387585514110:web:44749e6d92769fff6ad62f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ìƒíƒœ ë³€ìˆ˜
    let currentData = [];
    let selectedYear = new Date().getFullYear();
    let selectedQuarter = Math.ceil((new Date().getMonth() + 1) / 3);
    let isAdmin = false;
    let selectedMembers = new Set();

    const lvMap = [
        { lv: 100, name: "ğŸŒŒ ì€í•˜ìˆ˜", color: "#ef4444", bg: "#fef2f2", glow: true },
        { lv: 90, name: "ğŸŒ  ë³„ë˜¥ë³„", color: "#f97316", bg: "#fff7ed", glow: true },
        { lv: 80, name: "ğŸ’« íƒ€ì›ë³„", color: "#eab308", bg: "#fefce8", glow: true },
        { lv: 60, name: "â­ï¸ ë³„", color: "#ea580c", bg: "#fff7ed", glow: false },
        { lv: 40, name: "ğŸŒ™ ì´ˆìŠ¹ë‹¬", color: "#16a34a", bg: "#f0fdf4", glow: false },
        { lv: 20, name: "ğŸŒ‹ í™”ì‚°", color: "#2563eb", bg: "#eff6ff", glow: false },
        { lv: 10, name: "â›°ï¸ ì‚°", color: "#7c3aed", bg: "#f5f3ff", glow: false },
        { lv: 3, name: "ğŸŒ¿ í’€ì", color: "#64748b", bg: "#f8fafc", glow: false },
        { lv: 0, name: "ğŸ«˜ ì‹ ì…", color: "#94a3b8", bg: "#ffffff", glow: false }
    ];

    // ì´ˆê¸°í™”
    window.onload = () => {
        document.getElementById('activityDate').valueAsDate = new Date();
        document.getElementById('joinDate').valueAsDate = new Date();
        syncData();
    };

    // ë·° ì „í™˜
    window.showView = (v) => {
        document.querySelectorAll('.view-content, [id^="view"]').forEach(e => e.classList.add('hidden'));
        document.getElementById('view' + v.charAt(0).toUpperCase() + v.slice(1)).classList.remove('hidden');
        document.getElementById('btnStatus').className = `nav-btn ${v==='status'?'active':'inactive'}`;
        document.getElementById('btnAdmin').className = `nav-btn ${v!=='status'?'active':'inactive'}`;
    };

    window.handleAdminTab = () => isAdmin ? showView('admin') : showView('login');
    window.logout = () => { isAdmin = false; showView('status'); };

    // ì—°ë„/ë¶„ê¸° ë³€ê²½
    window.changeYear = (y) => {
        selectedYear = y;
        document.getElementById('currentYearTitle').innerText = y;
        document.querySelectorAll('#yearTabs button').forEach(b => b.classList.toggle('active', b.innerText.includes(y)));
        syncData();
    };

    window.changeQuarter = (q) => {
        selectedQuarter = q;
        document.querySelectorAll('#quarterTabs button').forEach((b, i) => b.classList.toggle('active', i+1 === q));
        syncData();
    };

    // ë°ì´í„° ë™ê¸°í™” (í•µì‹¬: ì„ íƒëœ ì—°ë„/ë¶„ê¸° í•„í„°ë§)
    let unsubscribe = null;
    async function syncData() {
        if (unsubscribe) unsubscribe();
        
        const start = Timestamp.fromDate(new Date(selectedYear, (selectedQuarter - 1) * 3, 1));
        const end = Timestamp.fromDate(new Date(selectedYear, selectedQuarter * 3, 1));

        unsubscribe = onSnapshot(collection(db, "sanwoori"), async (snap) => {
            const list = await Promise.all(snap.docs.map(async (docSnap) => {
                const m = { id: docSnap.id, ...docSnap.data() };
                const logsSnap = await getDocs(query(
                    collection(db, `sanwoori/${m.id}/logs`),
                    where("date", ">=", start),
                    where("date", "<", end)
                ));
                m.qCount = logsSnap.size;
                return m;
            }));
            currentData = list;
            renderTable();
            updateAdminUI();
        });
    }

    // í˜„í™© ë Œë”ë§
    window.renderTable = () => {
        const tbody = document.getElementById('statusList');
        const search = document.getElementById('searchInput').value.toLowerCase();
        const sort = document.getElementById('sortOrder').value;
        const today = new Date();
        today.setHours(0,0,0,0);

        let filtered = currentData.filter(m => m.name.toLowerCase().includes(search));
        
        // ì •ë ¬
        filtered.sort((a, b) => {
            if (sort === 'qCount') return b.qCount - a.qCount || b.level - a.level;
            if (sort === 'level') return b.level - a.level || b.qCount - a.qCount;
            return a.name.localeCompare(b.name, 'ko');
        });

        tbody.innerHTML = filtered.map(m => {
            const lvInfo = lvMap.find(l => m.level >= l.lv) || lvMap[lvMap.length-1];
            const last = m.lastDate.toDate();
            last.setHours(0,0,0,0);
            const diffDays = Math.floor((today - last) / 86400000);
            const ddayLimit = m.level === 0 ? 30 : 122;
            const dday = (ddayLimit + (m.bonusDays || 0)) - diffDays;
            
            let ddayClass = "text-slate-400 font-bold";
            if (dday <= 10) ddayClass = "dday-red";
            else if (dday <= 30) ddayClass = "dday-orange";

            return `
                <tr>
                    <td>
                        <div class="font-extrabold text-slate-700">${m.name}</div>
                        ${m.isHidden ? '<span class="text-[8px] bg-slate-100 px-1 rounded text-slate-400">HIDDEN</span>' : ''}
                    </td>
                    <td>
                        <div class="badge-box ${lvInfo.glow ? 'glow-active' : ''}" style="background:${lvInfo.bg}; border-color:${lvInfo.color}">
                            <span class="text-[10px] font-black" style="color:${lvInfo.color}">${lvInfo.name}</span>
                            <span class="text-[9px] opacity-60 font-bold" style="color:${lvInfo.color}">Lv.${m.level}</span>
                        </div>
                    </td>
                    <td class="text-center font-black text-slate-600">${m.qCount}íšŒ</td>
                    <td class="text-center text-[11px] ${ddayClass}">${dday >= 0 ? 'D-'+dday : '+'+Math.abs(dday)}</td>
                </tr>
            `;
        }).join('');
    };

    // ê´€ë¦¬ì ê´€ë ¨ í•¨ìˆ˜ë“¤
    window.loginAdmin = async () => {
        const pw = document.getElementById('adminPassword').value;
        const conf = await getDoc(doc(db, "admin_settings", "config"));
        if (conf.exists() && String(conf.data().admin_pw) === pw) {
            isAdmin = true;
            showView('admin');
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    };

    function updateAdminUI() {
        const grid = document.getElementById('adminMemberList');
        const select = document.getElementById('editMemberSelect');
        const alpha = [...currentData].sort((a,b) => a.name.localeCompare(b.name, 'ko'));

        grid.innerHTML = alpha.map(m => `
            <div class="chip ${selectedMembers.has(m.id)?'selected':''}" onclick="toggleSelect('${m.id}', this)">
                ${m.name}
            </div>
        `).join('');

        const currentVal = select.value;
        select.innerHTML = '<option value="">í¸ì§‘í•  ë©¤ë²„ ì„ íƒ</option>' + 
            alpha.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        select.value = currentVal;
    }

    window.toggleSelect = (id, el) => {
        if(selectedMembers.has(id)) { selectedMembers.delete(id); el.classList.remove('selected'); }
        else { selectedMembers.add(id); el.classList.add('selected'); }
    };

    window.addActivity = async () => {
        if(!selectedMembers.size) return alert("ë©¤ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        const up = parseInt(document.getElementById('upAmount').value);
        const dateStr = document.getElementById('activityDate').value;
        if(!dateStr) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        const ts = Timestamp.fromDate(new Date(dateStr + "T00:00:00"));

        for(const id of selectedMembers) {
            const mRef = doc(db, "sanwoori", id);
            const mSnap = await getDoc(mRef);
            let updateObj = { level: increment(up) };
            if(ts.toMillis() > mSnap.data().lastDate.toMillis()) updateObj.lastDate = ts;
            await updateDoc(mRef, updateObj);
            for(let i=0; i<up; i++) await addDoc(collection(db, `sanwoori/${id}/logs`), { date: ts });
        }
        alert("ê¸°ë¡ ì™„ë£Œ!");
        selectedMembers.clear();
        updateAdminUI();
    };

    window.loadLogs = async () => {
        const id = document.getElementById('editMemberSelect').value;
        const ctrl = document.getElementById('editControls');
        const logBox = document.getElementById('logContainer');
        if(!id) { ctrl.classList.add('hidden'); return; }
        
        ctrl.classList.remove('hidden');
        const m = currentData.find(x => x.id === id);
        document.getElementById('editNameInput').value = m.name;
        document.getElementById('bonusInput').value = m.bonusDays || 0;

        const logs = await getDocs(query(collection(db, `sanwoori/${id}/logs`), orderBy("date", "desc"), limit(12)));
        logBox.innerHTML = logs.docs.map(ld => {
            const d = ld.data().date.toDate();
            return `<div class="bg-slate-50 p-2 rounded-lg text-center">
                <div class="text-[9px] font-bold text-slate-500">${d.getMonth()+1}/${d.getDate()}</div>
                <button onclick="deleteLog('${id}', '${ld.id}')" class="text-[8px] text-red-500 font-black">DEL</button>
            </div>`;
        }).join('');
    };

    window.deleteLog = async (mId, logId) => {
        if(!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ê³  ë ˆë²¨ì„ 1 ì°¨ê°í• ê¹Œìš”?")) return;
        await deleteDoc(doc(db, `sanwoori/${mId}/logs`, logId));
        const logs = await getDocs(query(collection(db, `sanwoori/${mId}/logs`), orderBy("date", "desc"), limit(1)));
        let upObj = { level: increment(-1) };
        if(!logs.empty) upObj.lastDate = logs.docs[0].data().date;
        await updateDoc(doc(db, "sanwoori", mId), upObj);
        loadLogs();
    };

    window.updateName = async () => {
        const id = document.getElementById('editMemberSelect').value;
        const name = document.getElementById('editNameInput').value;
        if(id && name) {
            await updateDoc(doc(db, "sanwoori", id), { name });
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    };

    window.updateBonus = async () => {
        const id = document.getElementById('editMemberSelect').value;
        const days = parseInt(document.getElementById('bonusInput').value) || 0;
        await updateDoc(doc(db, "sanwoori", id), { bonusDays: days });
        alert("ë³´ë„ˆìŠ¤ ì ìš© ì™„ë£Œ");
    };

    window.registerMember = async () => {
        const name = document.getElementById('newName').value;
        const date = document.getElementById('joinDate').value;
        if(!name) return;
        await addDoc(collection(db, "sanwoori"), {
            name, level: 0, bonusDays: 0, isHidden: false,
            lastDate: Timestamp.fromDate(new Date(date + "T00:00:00"))
        });
        alert("ë“±ë¡ ì™„ë£Œ");
        document.getElementById('newName').value = "";
    };

    window.filterAdminMembers = () => {
        const q = document.getElementById('adminSearch').value.toLowerCase();
        document.querySelectorAll('.chip').forEach(c => {
            c.style.display = c.innerText.toLowerCase().includes(q) ? 'block' : 'none';
        });
    };
</script>
</body>
</html>
